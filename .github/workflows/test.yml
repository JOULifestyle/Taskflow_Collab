name: Run Tests

on:
  push:
    branches:
      - main
  pull_request:

jobs:
  # üß† FRONTEND TESTS
  frontend-tests:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        node-version: [18.x]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Use Node.js ${{ matrix.node-version }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node-version }}
          cache: 'npm'
          cache-dependency-path: ./frontend/package-lock.json

      - name: Install frontend dependencies
        working-directory: ./frontend
        run: npm ci

      - name: Run frontend tests
        working-directory: ./frontend
        run: npm test -- --watchAll=false

  # ‚öôÔ∏è BACKEND TESTS
  backend-tests:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        node-version: [18.x]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Use Node.js ${{ matrix.node-version }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node-version }}
          cache: 'npm'
          cache-dependency-path: ./backend/package-lock.json

      - name: Install backend dependencies (including dev)
        working-directory: ./backend
        run: npm ci --include=dev

      - name: Debug Jest installation
        working-directory: ./backend
        run: |
          echo "Checking if Jest is installed..."
          npm list jest || echo "Jest not found in npm list"
          ls -la node_modules/.bin/jest || echo "Jest binary not found in node_modules/.bin"
          echo "Node version: $(node --version)"
          echo "NPM version: $(npm --version)"

      - name: Verify Jest installation
        working-directory: ./backend
        run: npx jest --version

      - name: Run backend tests with coverage
        working-directory: ./backend
        run: npx jest --runInBand --coverage

      - name: Upload coverage report
        uses: actions/upload-artifact@v4
        with:
          name: backend-coverage
          path: ./backend/coverage
